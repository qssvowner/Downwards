<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Downwards</title>
    <style>
        body {
            margin: 0;
            background-color: #000000; 
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }
        #game-container {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #333;
        }
        #game-canvas {
            background-color: #1a1a1a;
            display: block;
            cursor: pointer;
        }
        .ui {
            text-align: center;
            color: #ffffff;
            margin-bottom: 10px;
        }
        #btn-config {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            color: white;
            opacity: 0.7;
        }
        #menu-opcoes {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            padding: 20px;
            border: 2px solid white;
            border-radius: 10px;
            color: white;
            text-align: center;
            z-index: 100;
            width: 250px;
        }
        #menu-opcoes input { width: 90%; margin: 10px 0; padding: 8px; border-radius: 5px; border: none; }
        #menu-opcoes button { padding: 8px 15px; cursor: pointer; background: white; border: none; font-weight: bold; margin-top: 5px; width: 100%; }
        #status-login { font-size: 14px; margin-bottom: 15px; color: #44ff44; display: none; }
    </style>
</head>
<body>

<div class="ui">
    <h1>Downwards</h1>
    <div style="font-size: 20px;">Pontos: <span id="pontos">0</span></div>
</div>

<div id="game-container">
    <div id="btn-config">⚙️</div>
    
    <div id="menu-opcoes">
        <h3>CONTA</h3>
        <div id="status-login"></div>
        <div id="area-login">
            <input type="text" id="user" placeholder="Usuário">
            <input type="password" id="pass" placeholder="Senha">
            <button onclick="cadastrar()">Cadastrar</button>
            <button onclick="login()" style="background: #44ff44;">Entrar</button>
        </div>
        <div id="area-logado" style="display: none;">
            <button onclick="logout()" style="background: #ff4444; color: white;">Sair</button>
        </div>
        <br>
        <button onclick="fecharMenu()" style="background: #666; color: white;">Voltar</button>
    </div>

    <canvas id="game-canvas"></canvas>
</div>

<audio id="musicaFundo" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<script>
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const displayPontos = document.getElementById('pontos');
    const musica = document.getElementById('musicaFundo');
    const menu = document.getElementById('menu-opcoes');
    
    musica.volume = 0.05;
    canvas.width = 350;
    canvas.height = 500;

    let jogoAtivo = true;
    let jogoIniciado = false;
    let podeRespawnar = false; 
    let score = 0;
    const player = { x: canvas.width / 2, y: canvas.height - 60 };
    let obstaculos = [];
    let timeoutObstaculo = null;

    function moverPlayer(clientX) {
        if (!jogoIniciado || !jogoAtivo || menu.style.display === 'block') return;
        const rect = canvas.getBoundingClientRect();
        player.x = clientX - rect.left;
        if (player.x < 15) player.x = 15;
        if (player.x > canvas.width - 15) player.x = canvas.width - 15;
    }

    canvas.addEventListener('mousemove', (e) => moverPlayer(e.clientX));
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        moverPlayer(e.touches[0].clientX);
    }, { passive: false });

    window.onload = () => {
        const salvo = localStorage.getItem('usuarioLogado');
        if (salvo) exibirLogado(salvo);
    };

    function exibirLogado(nome) {
        document.getElementById('area-login').style.display = 'none';
        document.getElementById('area-logado').style.display = 'block';
        const st = document.getElementById('status-login');
        st.style.display = 'block';
        st.innerText = "Olá, " + nome;
    }

    function cadastrar() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if(u && p) { localStorage.setItem('u_' + u, p); alert("Conta criada!"); }
    }

    function login() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if(localStorage.getItem('u_' + u) === p) {
            localStorage.setItem('usuarioLogado', u);
            exibirLogado(u);
        } else { alert("Incorreto!"); }
    }

    function logout() { localStorage.removeItem('usuarioLogado'); location.reload(); }

    document.getElementById('btn-config').onclick = () => {
        menu.style.display = 'block';
        jogoAtivo = false;
        if (timeoutObstaculo) clearTimeout(timeoutObstaculo);
    };

    function fecharMenu() {
        menu.style.display = 'none';
        if (jogoIniciado) {
            jogoAtivo = true;
            criarObstaculo(); // Reinicia o nascimento dos itens
            requestAnimationFrame(atualizar);
        }
    }

    const clicarTela = () => {
        if (menu.style.display === 'block') return;
        musica.play().catch(() => {});
        if (!jogoIniciado) {
            jogoIniciado = true;
            canvas.style.cursor = 'none';
            criarObstaculo();
        } else if (!jogoAtivo && podeRespawnar) {
            resetarJogo();
        }
    };

    canvas.addEventListener('mousedown', clicarTela);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); clicarTela(); }, { passive: false });

    function criarObstaculo() {
        if (!jogoAtivo || !jogoIniciado) return;
        
        // Garante que não existam múltiplos loops de criação
        if (timeoutObstaculo) clearTimeout(timeoutObstaculo);

        obstaculos.push({ 
            x: Math.random() * (canvas.width - 30) + 15, 
            y: -30, 
            speed: 3 + (score / 200), 
            angulo: 0 
        });
        
        let proximoSpawn = Math.max(250, 900 - (score * 1.2));
        timeoutObstaculo = setTimeout(criarObstaculo, proximoSpawn);
    }

    function resetarJogo() {
        score = 0; 
        displayPontos.innerText = "0"; 
        obstaculos = []; 
        jogoAtivo = true; 
        podeRespawnar = false;
        player.x = canvas.width / 2; 
        if (timeoutObstaculo) clearTimeout(timeoutObstaculo);
        canvas.style.cursor = 'none';
        criarObstaculo(); 
        requestAnimationFrame(atualizar);
    }

    function atualizar() {
        if (!jogoAtivo) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (!jogoIniciado) {
            ctx.fillStyle = "white"; 
            ctx.textAlign = "center"; 
            ctx.font = "bold 25px Arial";
            ctx.fillText("PRONTO?", canvas.width/2, canvas.height/2);
        } else {
            ctx.fillStyle = "white"; 
            ctx.font = "53px serif"; 
            ctx.textAlign = "center";
            ctx.fillText("■", player.x, player.y);

            for (let i = obstaculos.length - 1; i >= 0; i--) {
                let o = obstaculos[i]; 
                o.y += o.speed; 
                o.angulo += 0.05; // Velocidade de rotação corrigida

                ctx.save(); 
                ctx.translate(o.x, o.y); 
                ctx.rotate(o.angulo);
                ctx.fillStyle = "white"; 
                ctx.font = "25px Arial"; 
                ctx.textBaseline = "middle";
                ctx.fillText("?", 0, 0); 
                ctx.restore();

                const dx = player.x - o.x; 
                const dy = (player.y - 15) - o.y;
                if (Math.sqrt(dx*dx + dy*dy) < 28) {
                    jogoAtivo = false; 
                    canvas.style.cursor = 'pointer';
                    if (timeoutObstaculo) clearTimeout(timeoutObstaculo);
                    setTimeout(() => podeRespawnar = true, 300);
                    ctx.fillStyle = "rgba(0,0,0,0.85)"; 
                    ctx.fillRect(0,0,canvas.width,canvas.height);
                    ctx.fillStyle = "white"; 
                    ctx.font = "bold 25px Arial";
                    ctx.fillText("FIM DE JOGO", canvas.width/2, canvas.height/2);
                    return;
                }
                if (o.y > canvas.height + 50) { 
                    obstaculos.splice(i, 1); 
                    score += 10; 
                    displayPontos.innerText = score; 
                }
            }
        }
        requestAnimationFrame(atualizar);
    }
    atualizar();
</script>
</body>
</html>
